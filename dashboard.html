<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Studio8 Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --navy: #102f44;
  --navy-soft: #143c55;
  --gold: #f4c26b;
  --white: #ffffff;
  --muted: #9aa7b1;
}

body {
  margin: 0;
  background: #f6f8fa;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

.container {
  max-width: 1100px;
  margin: 40px auto;
  padding: 0 20px;
}

.card {
  background: var(--navy);
  border-radius: 14px;
  padding: 28px;
  margin-bottom: 28px;
  color: var(--white);
}

/* Force readable text */
.card, .card * {
  color: #ffffff;
}

.welcome h2 {
  margin: 0 0 10px;
  font-size: 26px;
}

.badge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
}

.badge.member { background: #1e6091; }
.badge.non-member { background: #8a6d1d; }

.services {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
}

.service {
  background: var(--navy-soft);
  border-radius: 14px;
  padding: 20px;
  cursor: pointer;
  border: 2px solid transparent;
  transition: 0.15s ease;
}

.service.selected {
  border-color: var(--gold);
  box-shadow: 0 0 0 2px rgba(244,194,107,.25);
}

.service h4 { margin: 0 0 8px; }
.price { font-size: 20px; font-weight: 700; color: var(--gold); }

.upload-box {
  margin-top: 20px;
  padding: 20px;
  border: 2px dashed #355f77;
  border-radius: 12px;
  text-align: center;
  display: none;
}

.actions { margin-top: 20px; }

button {
  width: 100%;
  padding: 16px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  cursor: pointer;
}

button.primary {
  background: #0b6fd3;
  color: #ffffff;
}

button.disabled {
  background: var(--muted);
  cursor: not-allowed;
}

.membership-box {
  margin-top: 18px;
}

.membership-box button {
  background: transparent;
  color: var(--gold);
  border: 2px solid var(--gold);
}

.membership-upload {
  display: none;
  margin-top: 14px;
  border: 2px dashed #355f77;
  padding: 16px;
  border-radius: 12px;
  text-align: center;
}
</style>
</head>

<body>

<script>
/* ===============================
   HARD SESSION GUARD (NO LOOP)
================================ */
const sessionRaw = sessionStorage.getItem("studio8_user");
if (!sessionRaw) {
  document.body.innerHTML = `
    <div style="padding:60px;font-family:sans-serif">
      <h2>Session expired</h2>
      <p>Please log in again.</p>
    </div>`;
  throw new Error("No session");
}
</script>

<div class="container">

  <!-- Welcome -->
  <div class="card welcome">
    <h2 id="welcomeText"></h2>
    <span id="statusBadge" class="badge"></span>
  </div>

  <!-- Services -->
  <div class="card">
    <h3>Select Service</h3>

    <div class="services" id="services"></div>

    <div class="upload-box" id="serviceUpload">
      <strong>Upload proof of payment</strong><br><br>
      <input type="file" id="serviceProof">
    </div>

    <div class="actions">
      <button id="loginBtn" class="disabled" disabled>
        Login to Training
      </button>
    </div>

    <div class="membership-box">
      <button onclick="toggleMembershipUpload()">
        Pay Annual Membership (₱600 / year) — Optional
      </button>

      <div class="membership-upload" id="membershipUpload">
        <strong>Upload proof of membership payment</strong><br><br>
        <input type="file">
      </div>
    </div>
  </div>

</div>

<script>
/* ===============================
   USER CONTEXT
================================ */
const user = JSON.parse(sessionRaw);
const firstName = user.full_name.split(" ")[0];
const status = user.status || "NON_MEMBER";

document.getElementById("welcomeText").textContent = `Welcome, ${firstName}`;

const badge = document.getElementById("statusBadge");
badge.textContent = status === "MEMBER" ? "Member" : "Non-Member";
badge.classList.add(status === "MEMBER" ? "member" : "non-member");

if (status === "MEMBER") {
  const membershipBox = document.querySelector(".membership-box");
  if (membershipBox) {
    membershipBox.style.display = "none";
  }
}

/* ===============================
   SERVICES
================================ */
const rates = {
  MEMBER: [
    { id: "bjj_day", name: "BJJ – 1 Day Pass", price: 400 },
    { id: "360_day", name: "360 – 1 Day Pass", price: 300 },
    { id: "bjj_month", name: "BJJ – Monthly", price: 3000 },
    { id: "360_month", name: "360 – Monthly", price: 2200 },
    { id: "combo", name: "BJJ + 360 – Monthly", price: 4500 }
  ],
  NON_MEMBER: [
    { id: "bjj_day", name: "BJJ – 1 Day Pass", price: 450 },
    { id: "360_day", name: "360 – 1 Day Pass", price: 350 },
    { id: "bjj_month", name: "BJJ – Monthly", price: 3300 },
    { id: "360_month", name: "360 – Monthly", price: 2500 },
    { id: "combo", name: "BJJ + 360 – Monthly", price: 5000 }
  ]
};

const servicesEl = document.getElementById("services");
const uploadBox = document.getElementById("serviceUpload");
const loginBtn = document.getElementById("loginBtn");

let selectedService = null;

rates[status].forEach(s => {
  const div = document.createElement("div");
  div.className = "service";
  div.innerHTML = `<h4>${s.name}</h4><div class="price">₱${s.price}</div>`;
  div.onclick = () => {
    document.querySelectorAll(".service").forEach(x => x.classList.remove("selected"));
    div.classList.add("selected");
    selectedService = s.id;
    uploadBox.style.display = "block";
  };
  servicesEl.appendChild(div);
});

document.getElementById("serviceProof").addEventListener("change", () => {
  loginBtn.disabled = false;
  loginBtn.classList.remove("disabled");
  loginBtn.classList.add("primary");
});

function toggleMembershipUpload() {
  const box = document.getElementById("membershipUpload");
  box.style.display = box.style.display === "block" ? "none" : "block";
}

/* ===============================
   TRAINING LOGIN SUBMIT
================================ */
loginBtn.addEventListener("click", submitTrainingLogin);

async function submitTrainingLogin() {
  if (!selectedService) {
    alert("Please select a service");
    return;
  }

  const fileInput = document.getElementById("serviceProof");
  if (!fileInput.files.length) {
    alert("Please upload proof of payment");
    return;
  }

  loginBtn.textContent = "Submitting...";
  loginBtn.disabled = true;

  const form = new FormData();
  form.append("service_id", selectedService);
  form.append("proof", fileInput.files[0]);

  try {
    const res = await fetch("https://api.donutskip.com/training/login", {
      method: "POST",
      credentials: "include",
      body: form
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Server error");

    alert("Training login recorded. Welcome!");
    loginBtn.textContent = "Logged In";
  } catch (err) {
    alert(err.message);
    loginBtn.textContent = "Login to Training";
    loginBtn.disabled = false;
  }
}
</script>

</body>
</html>
